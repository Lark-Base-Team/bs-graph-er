(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[383],{43383:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return Home}});var l,a,n=i(44810),s=i(78026),o=i(24576),r=i(34484),d=i.n(r),u=i(48466),c=i(80009),p=i(79246),f=i(6288),h=i(81057),g=i(7124);i(15788);var y=i(23867),m=i.n(y);let b=new(m()).graphlib.Graph().setDefaultEdgeLabel(()=>({})),getLayoutedElements=(e,t,i)=>{b.setGraph({rankdir:i.direction});let l=document.querySelectorAll(".kvlist-node"),a=Array.from(l).reduce((e,t)=>{let i=t.id;return{...e,[i]:t.clientHeight}},{});return t.forEach(e=>b.setEdge(e.source,e.target)),e.forEach(e=>b.setNode(e.id,Object.assign(e,{width:400,height:a[e.id]||100}))),m().layout(b),{nodes:e.map(e=>{let{x:t,y:i}=b.node(e.id);return{...e,position:{x:t,y:i}}}),edges:t}};var x=i(83260);function KVList(e){return(0,n.jsx)("div",{className:"kvlist-node",id:e.id,children:(0,n.jsx)(s.Zb,{style:{background:"#fff"},headerStyle:{paddingTop:15,paddingBottom:15},bodyStyle:{paddingTop:0,paddingBottom:0},title:(0,n.jsxs)("h1",{children:[!e.data.start&&(0,n.jsx)(c.HH,{type:"target",position:c.Ly.Left,style:{top:30}}),e.data.label]}),children:(0,n.jsx)(s.l0,{labelPosition:"left",labelAlign:"right",initValues:formatValues(e.data.data),onClickCapture:e=>{e.stopPropagation()},children:e.data.fields.map((e,t)=>(0,n.jsxs)("div",{children:[(0,n.jsx)(s.l0.Input,{field:e.id,label:e.label,readonly:!0,trigger:"blur",style:{width:200}}),(e.type===x.fS.SingleLink||e.type===x.fS.DuplexLink)&&(0,n.jsx)(c.HH,{id:e.id,type:"source",style:{top:56*t+52+29},position:c.Ly.Right})]},e.id))})})})}function formatValues(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=e.reduce((e,t)=>(e[t.field]=t.value,e),{});return t}var j=i(70146);let v={kvlist:KVList},LayoutFlow=e=>{let{initialNodes:t=[],initialEdges:i=[],fullscreen:l=!1}=e,{fitView:a}=(0,c._K)(),[s,r,d]=(0,c.Rr)(t),[u,y,m]=(0,c.ll)(i),b=(0,o.useCallback)(()=>{let{nodes:e,edges:t}=getLayoutedElements(s,u,{direction:"LR"});console.log(e,t),r([...e]),y([...t]),window.requestAnimationFrame(()=>{a()})},[s,u]),x=(0,o.useCallback)(e=>y(t=>(0,c.Z_)(e,t)),[y]),k=(0,o.useCallback)(e=>{b(),setTimeout(()=>{e.fitView({maxZoom:.9})})},[b]),w=(0,o.useCallback)(()=>{let e=open("/","_block");e&&(e.options=()=>({initialEdges:i,initialNodes:t,fullscreen:!0}))},[i,t]);return(0,n.jsxs)(c.x$,{nodeTypes:v,attributionPosition:"bottom-left",nodes:s,edges:u,onNodesChange:d,onEdgesChange:m,onConnect:x,onInit:k,minZoom:.1,children:[(0,n.jsx)(p.Z,{children:!l&&(0,n.jsx)(p.B,{onClick:()=>w(),children:(0,n.jsx)(j.Z,{})})}),l&&(0,n.jsx)(f.a,{}),(0,n.jsx)(h.M,{}),(0,n.jsx)(g.A,{variant:g.T.Dots,gap:12,size:1})]})};function trans(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=[],i=[],l=!1;for(let a=0;a<e.length;a++){let n=e[a],s={id:n.id,type:"kvlist",position:{x:0,y:0},data:{start:0===a,end:a===e.length-1,label:n.label,fields:n.fields,data:n.data}};t.push(s);for(let e=0;e<n.fields.length;e++){let a=n.fields[e];if(a.type===x.fS.SingleLink||a.type===x.fS.DuplexLink){let e=a.property.tableId,s={id:n.id+"-"+a.id+"-"+e,sourceHandle:a.id,source:n.id,target:e};t[0].id===s.target?(l=!0,i.push({id:"root-ref-edge"+s.id+"-"+s.source,sourceHandle:s.sourceHandle,source:s.source,target:"root-ref"})):i.push(s)}}}return l&&t.push({id:"root-ref",type:"output",position:{x:0,y:0},height:200,data:{label:"Ref<".concat(t[0].data.label,">")},targetPosition:"left"}),[t,i]}var k=i(94255),w=i(77675);let C=(null===(a=window)||void 0===a?void 0:null===(l=a.options)||void 0===l?void 0:l.call(a))||{},L=(0,k.Z)();async function fetchTables(){let e=await x.ws.base.getTableList();return await bsTableTrans(e)}async function bsTableTrans(e){let t=[];for(let i=0;i<e.length;i++){let l=e[i],a=await l.getName(),n=await l.getFieldList().then(e=>Promise.all(e.map(e=>e.getMeta()))),s=n.find(e=>e.isPrimary);t.push({id:l.id,label:a,primary:null==s?void 0:s.id,meta:l,fields:n.map(e=>({id:e.id,label:e.name,type:e.type,property:e.property,meta:e})),data:n.map(e=>({field:e.id,value:x.fS[e.type]}))})}return t}function Home(){let[e]=(0,u.$G)(),[t,i]=(0,o.useState)({}),[l,a]=(0,o.useState)(!0),[r,p]=(0,o.useState)(!1),[f,h]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{if(C.fullscreen){h(!0),a(!0),i(C),a(!1);return}return fetchTables().then(e=>{a(!0),p(!1),console.log({tables:e});let[t,l]=trans(e);console.log({initialNodes:t,initialEdges:l}),i({initialNodes:t,initialEdges:l}),p(!0),setTimeout(()=>{a(!1)},100)}),()=>{}},[]),(0,n.jsxs)("main",{className:d().main,style:{width:"100vw",height:"100vh",display:"flex",justifyContent:"center",alignItems:"center"},children:[f?r&&(0,n.jsx)(c.tV,{children:(0,n.jsx)(LayoutFlow,{...t})}):(0,n.jsx)(s.HY,{image:(0,n.jsx)(w.xs,{style:{width:150,height:150}}),darkModeImage:(0,n.jsx)(w.m3,{style:{width:150,height:150}}),description:e("empty-tip")}),l&&(0,n.jsx)("div",{style:{width:"100%",height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#fff",position:"fixed",top:0,left:0,zIndex:100},children:(0,n.jsx)(s.yC,{size:"large"})})]})}C.fullscreen||x.ws.base.onSelectionChange(async e=>{L.emit("change-record",e)})},34484:function(e){e.exports={main:"Home_main__ElU3j",h4:"Home_h4__4GCIr",code:"Home_code__ESbU9"}}}]);
//# sourceMappingURL=383.9d872e9f14ac785d.js.map