(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[383],{43383:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return Home}});var l,n,a=i(44810),s=i(78026),o=i(24576),d=i(34484),r=i.n(d),u=i(48466),c=i(80009),p=i(79246),f=i(6288),h=i(81057),g=i(7124);i(15788);var m=i(23867),y=i.n(m);let b=new(y()).graphlib.Graph().setDefaultEdgeLabel(()=>({})),getLayoutedElements=(e,t,i)=>{b.setGraph({rankdir:i.direction});let l=document.querySelectorAll(".kvlist-node"),n=Array.from(l).reduce((e,t)=>{let i=t.id;return{...e,[i]:t.clientHeight}},{});return t.forEach(e=>b.setEdge(e.source,e.target)),e.forEach(e=>b.setNode(e.id,Object.assign(e,{width:400,height:n[e.id]||100}))),y().layout(b),{nodes:e.map(e=>{let{x:t,y:i}=b.node(e.id);return{...e,position:{x:t,y:i}}}),edges:t}};var x=i(83260);function KVList(e){return(0,a.jsx)("div",{className:"kvlist-node",id:e.id,children:(0,a.jsx)(s.Zb,{style:{background:"#fff"},headerStyle:{paddingTop:15,paddingBottom:15},bodyStyle:{paddingTop:0,paddingBottom:0},title:(0,a.jsxs)("h1",{children:[(0,a.jsx)(c.HH,{type:"target",position:c.Ly.Left,style:{top:30}}),e.data.label]}),children:(0,a.jsx)(s.l0,{labelPosition:"left",labelAlign:"right",initValues:formatValues(e.data.data),onClickCapture:e=>{e.stopPropagation()},children:e.data.fields.map((e,t)=>(0,a.jsxs)("div",{children:[(0,a.jsx)(s.l0.Input,{field:e.id,label:e.label,readonly:!0,trigger:"blur",style:{width:200}}),(e.type===x.fS.SingleLink||e.type===x.fS.DuplexLink)&&(0,a.jsx)(c.HH,{id:e.id,type:"source",style:{top:56*t+52+29},position:c.Ly.Right})]},e.id))})})})}function formatValues(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=e.reduce((e,t)=>(e[t.field]=t.value,e),{});return t}var j=i(70146);let v={kvlist:KVList},LayoutFlow=e=>{let{initialNodes:t=[],initialEdges:i=[],fullscreen:l=!1}=e,{fitView:n}=(0,c._K)(),[s,d,r]=(0,c.Rr)(t),[u,m,y]=(0,c.ll)(i),b=(0,o.useCallback)(()=>{let{nodes:e,edges:t}=getLayoutedElements(s,u,{direction:"LR"});console.log(e,t),d([...e]),m([...t]),window.requestAnimationFrame(()=>{n()})},[s,u]),x=(0,o.useCallback)(e=>m(t=>(0,c.Z_)(e,t)),[m]),k=(0,o.useCallback)(e=>{b(),setTimeout(()=>{e.fitView({maxZoom:.9})})},[b]),w=(0,o.useCallback)(()=>{let e=open("/","_block");e&&(e.options=()=>({initialEdges:i,initialNodes:t,fullscreen:!0}))},[i,t]);return(0,a.jsxs)(c.x$,{nodeTypes:v,attributionPosition:"bottom-left",nodes:s,edges:u,onNodesChange:r,onEdgesChange:y,onConnect:x,onInit:k,minZoom:.1,children:[(0,a.jsx)(p.Z,{children:!l&&(0,a.jsx)(p.B,{onClick:()=>w(),children:(0,a.jsx)(j.Z,{})})}),l&&(0,a.jsx)(f.a,{}),(0,a.jsx)(h.M,{}),(0,a.jsx)(g.A,{variant:g.T.Dots,gap:12,size:1})]})};function trans(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=[],i=[];for(let l=0;l<e.length;l++){let n=e[l],a={id:n.id,type:"kvlist",position:{x:0,y:0},data:{start:0===l,end:l===e.length-1,label:n.label,fields:n.fields,data:n.data}};t.push(a);for(let e=0;e<n.fields.length;e++){let t=n.fields[e];if(t.type===x.fS.SingleLink||t.type===x.fS.DuplexLink){let e=t.property.tableId,l={id:n.id+"-"+t.id+"-"+e,sourceHandle:t.id,source:n.id,target:e};i.push(l)}}}return[t,i]}var k=i(94255),w=i(77675);let C=(null===(n=window)||void 0===n?void 0:null===(l=n.options)||void 0===l?void 0:l.call(n))||{},L=(0,k.Z)();async function fetchTables(){let e=await x.ws.base.getTableList();return await bsTableTrans(e)}async function bsTableTrans(e){let t=[];for(let i=0;i<e.length;i++){let l=e[i],n=await l.getName(),a=await l.getFieldList().then(e=>Promise.all(e.map(e=>e.getMeta()))),s=a.find(e=>e.isPrimary);t.push({id:l.id,label:n,primary:null==s?void 0:s.id,meta:l,fields:a.map(e=>({id:e.id,label:e.name,type:e.type,property:e.property,meta:e})),data:a.map(e=>({field:e.id,value:x.fS[e.type]}))})}return t}function Home(){let[e]=(0,u.$G)(),[t,i]=(0,o.useState)({}),[l,n]=(0,o.useState)(!0),[d,p]=(0,o.useState)(!1),[f,h]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{if(C.fullscreen){h(!0),n(!0),i(C),n(!1),p(!0);return}return fetchTables().then(e=>{n(!0),p(!1),console.log({tables:e});let[t,l]=trans(e);console.log({initialNodes:t,initialEdges:l}),i({initialNodes:t,initialEdges:l}),p(!0),setTimeout(()=>{n(!1)},100)}),()=>{}},[]),(0,a.jsxs)("main",{className:r().main,style:{width:"100vw",height:"100vh",display:"flex",justifyContent:"center",alignItems:"center"},children:[f?d&&(0,a.jsx)(c.tV,{children:(0,a.jsx)(LayoutFlow,{...t})}):(0,a.jsx)(s.HY,{image:(0,a.jsx)(w.xs,{style:{width:150,height:150}}),darkModeImage:(0,a.jsx)(w.m3,{style:{width:150,height:150}}),description:e("empty-tip")}),l&&(0,a.jsx)("div",{style:{width:"100%",height:"100vh",display:"flex",justifyContent:"center",alignItems:"center",background:"#fff",position:"fixed",top:0,left:0,zIndex:100},children:(0,a.jsx)(s.yC,{size:"large"})})]})}C.fullscreen||x.ws.base.onSelectionChange(async e=>{L.emit("change-record",e)})},34484:function(e){e.exports={main:"Home_main__ElU3j",h4:"Home_h4__4GCIr",code:"Home_code__ESbU9"}}}]);
//# sourceMappingURL=383.df19e8de7bc8ebb5.js.map